# flask-script

`pip install flask-script`

> 使用里面的Manager进行命令得到管理和使用：

```python
from flask import Flask
from flask_script import Mangaer

app = Flask(__name__)

manager = Manager(app=app)


if __name__ == '__main__':
    manager.run()		 ---->启动
```

> 使用命令在终端才能启动：

- -h 主机   --host 主机
- -p 端口号 --port 端口号
- -d --debug
- -D --no-debug
- -r --reload
- -R --no-reload

```python
python app.py runserver
python app.py runserver -h 0.0.0.0 -p 5001
```

> 自定义添加命令：

```python
@manager.command
def init():
    print('初始化')

# 命令 python app.py init
```



# 数据库

安装：
`pip3 install pymysql`              建公路

`pip3 install flask-sqlalchemy`    实现ORM映射

`pip3 install flask-migrate`       发布命令工具

## 配置数据库的连接路径

```python
SQLALCHEMY_DATABASE_URI = 'mysql+pymysql://user:password@host:port/databasename'

SQLALCHEMY_DATABASE_URI = 'mysql+pymysql://root:root@127.0.0.1:3306/mb'
```

\settings

```python
class Config:
    DEBUG = True
    # mysql+pymysql://user:password@hostip:port/databasename
    SQLALCHEMY_DATABASE_URI = 'mysql+pymysql://root:root@127.0.0.1:3306/mb'


class DevelopmentConfig(Config):
    ENV = 'development'


class ProductionConfig(Config):
    ENV = 'production'
    DDEBUG = False

```



## flask-sqlalchemy的搭建

> 创建包ext

`\ext\__init__.py `

```python

db = SQLAlchemy()   ---->必须跟app联系
def create_app():
    ....
    db.init_app(app)
    return app
```

## app关联ext

`\app\__init__.py`

```python
from flask import Flask

import settings
from apps.user.view import user_bp
# 导入映射的db
from ext import db


def create_app():
    app = Flask(__name__,
                template_folder='../templates', # 要定义templates和static文件夹位置,因为默认是在__init__同级别
                static_folder='../static')      # 这两个路径和参数1:import_name就是`__name__`相关,是根据它来确定自己的相对路径

    app.config.from_object(settings)    # 导入配置文件
    app.register_blueprint(user_bp)     # 注册蓝图 里面的路由就直接用就可以,不需要加url前缀
    db.init_app(app)                    # 将db对象与app进行了关联
    return app

```



## flask-migrate的配置：

```python
migrate = Migrate(app=app, db=db)
manager.add_command('db', MigrateCommand)
```

## 创建模型：

> models.py
>
> 模型就是类，经常称作模型类

```python
class User(db.Model):      ------> user表
    id = db.Column(db.Integer, primary_key=True, autoincrement=True)
    username  = db.Column(db.String(15), nullable=False)
    password  = db.Column(db.String(12), nullable=False)
    phone     = db.Column(db.String(11), unique=True)
    rdatetime = db.Column(db.DateTime, default=datetime.now)
```

> 常见的数据类型：

- Integer        整型
- String(size)   字符串类型，务必指定大小
- Text           长文本类型
- DateTime       日期时间
- Float          浮点类型
- Boolean        布尔类型
- PickleType     存储pickle类型  主要跟序列化有关
- LargeBinary    存储大的二进制类型

> 可选的：

- primary_key=True      主键
- autoincrement=True    自增
- nullable=False        不允许为空
- unique=True           唯一
- default=datetime.now  默认值  可以设置成当前系统时间或者其他的值

## 使用命令

在app.py 中导入模型: `from apps.user.models import User`

    b. 在终端使用命令：db
        python3 app.py db init   -----》 产生一个文件夹migrations
        python3 app.py db migrate -----> 自动产生了一个版本文件
         项目
          | ---apps
          | ---ext
          | ---migrations    python3 app.py db init     只需要init一次
                   |---versions   版本文件夹
                        |---71edde7ee937_.py    ---》  python3 app.py db migrate  迁移
                        |---cc0dca61130f_.py
                                                      python3 app.py db upgrade 同步
                                                      python3 app.py db downgrade 降级

# 添加数据：以注册为例：

> 模板，视图与模型结合

## 1. 找到模型类并创建对象

`user = User()`

## 2. 给对象的属性赋值

```python
user.username = username
user.password = password
user.phone = phone
```



## 3.将user对象添加到session中（类似缓存）

`db.session.add(user)`

## 4.提交数据

`db.session.commit()`

