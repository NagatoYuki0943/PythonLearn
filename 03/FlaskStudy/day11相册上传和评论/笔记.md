# 上传图片

> apps/user/view.py

```python
#上传图片
@user_bp.route('/upphoto', methods=['GET', 'POST'])
def upphoto():
    photo = request.files.get('photo')
    photo_name = photo.filename
    # 必须是图片格式,没有上传图片就不就修改
    if photo_name.split('.')[-1] in ALLOWED_EXTENSIONS:
        # 随机名字
        r = str(random.randint(1, 99999))
        photo_name = r + photo_name
        # 绝对路径
        file_path = os.path.join(Config.UPLOAD_PHOTO_DIR, photo_name)
        # 保存文件,save(路径)
        photo.save(file_path)

        photo = Photo()
        # 实际存储路径
        photo.name = 'upload/photo/' + photo_name
        photo.user_id = session.get('uid')
        db.session.add(photo)
        db.session.commit()

    return redirect(url_for('user.center'))
```

> templates/user/center.html

```html
<form action="{{ url_for('user.upphoto') }}" method="post" enctype="multipart/form-data" class="form-inline">
    <input type="file" name="photo" class="form-control">
    <input type="submit" value="上传相册" class="btn btn-default">
</form>
```



# 删除图片

>apps/user/view.py

```python
# 软删除图片
@user_bp.route('/delphoto', methods=['GET', 'POST'])
def delphoto():
    photoid = request.args.get('id')

    photo = Photo.query.get(photoid)
    photo.isdelete = True   # 软删除
    db.session.commit()
    return {'code':200, 'msg': '删除成功'}
```

> templates/user/center.html
>
> 有弹框提示是否删除

```html
{% for photo in photos %}
    <div class="col-xs-8 col-sm-4">
        <img id="{{ photo.id }}" src="{{ url_for('static', filename=photo.name) }}" alt="..." class="img-rounded image">
        <button class="btn btn-info btn-xs photo-del" tag="#">删除</button>
    </div>
{% endfor %}

<script>
//删除图片
$('.photo-del').click(function(){
    //确认是否删除
    flag = confirm('确定删除吗')
    if(flag){
        //找到图片id
        let id = $(this).prev('img').attr('id')
        $.get(
            "{{ url_for('user.delphoto') }}",
            {id: id}
        ).then(({code, msg})=>{
            console.log(code);
            if(code=200){
                //去除父级的div
                $(this).parent('div').remove()
            }
        })
    }
})
</script>
```


# 错误页面

>apps/user/view.py

```python
# 错误页面
@user_bp.route('error')
def error():
    referer = request.headers.get('Referer')
    return render_template('500.html', error_msg="错误", referer=referer)
```

> templates/500.html

```html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>错误</title>
    <style>
        h1{
            color: red;
        }
    </style>
</head>
<body>
    <h1>{{ error_msg }}</h1>
    {# 有上一页就回到上一页, 否则就回到首页 #}
    <a href="{% if referer %} {{ referer }} {% else %} /user/ {% endif %}">返回上一页</a>
</body>
</html>
```

